
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>responses: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">flow-service/pkg/responses/response.go (60.5%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">/*
@module pkg/responses/response
@description 统一API响应格式框架，提供标准化的HTTP响应结构和封装方法
@architecture 响应层架构，支持成功、错误、分页等多种响应类型的统一处理
@documentReference ../../../ai_docs/dev_plan.md - 第六阶段API层完善
@stateFlow 无状态响应封装，每次调用独立处理
@rules
  - 统一的JSON响应格式
  - 标准化的错误码和消息：status=0表示成功，status&gt;0表示各种错误
  - 支持分页查询响应
  - 支持数据验证和格式化

@dependencies
  - net/http: HTTP状态码
  - encoding/json: JSON序列化
  - github.com/go-chi/chi/v5: 路由框架

@refs api/controllers - 控制器层使用响应封装
*/
package responses

import (
        "encoding/json"
        "fmt"
        "net/http"
        "reflect"
        "time"
)

// Response 标准响应结构
type Response struct {
        Status    int         `json:"status"`               // 业务状态码：0=成功，&gt;0=错误
        Msg       string      `json:"msg"`                  // 响应消息
        Data      interface{} `json:"data,omitempty"`       // 响应数据
        Timestamp int64       `json:"timestamp"`            // 时间戳
        RequestID string      `json:"request_id,omitempty"` // 请求ID
}

// ListResponse 列表响应结构
type ListResponse struct {
        Items      interface{}     `json:"items"`                // 数据项
        Pagination *PaginationInfo `json:"pagination,omitempty"` // 分页信息
        Total      int64           `json:"total"`                // 总数量
        Count      int             `json:"count"`                // 当前数量
}

// PaginationInfo 分页信息
type PaginationInfo struct {
        Page       int   `json:"page"`        // 当前页码
        PageSize   int   `json:"page_size"`   // 每页大小
        TotalPages int   `json:"total_pages"` // 总页数
        Total      int64 `json:"total"`       // 总记录数
        HasNext    bool  `json:"has_next"`    // 是否有下一页
        HasPrev    bool  `json:"has_prev"`    // 是否有上一页
}

// ErrorDetail 错误详情
type ErrorDetail struct {
        Field   string `json:"field,omitempty"` // 字段名
        Message string `json:"message"`         // 错误消息
        Code    string `json:"code,omitempty"`  // 错误码
}

// ErrorResponse 错误响应结构
type ErrorResponse struct {
        Status    int            `json:"status"`               // 业务错误码：&gt;0表示错误
        Msg       string         `json:"msg"`                  // 错误消息
        Details   []*ErrorDetail `json:"details,omitempty"`    // 错误详情
        Timestamp int64          `json:"timestamp"`            // 时间戳
        RequestID string         `json:"request_id,omitempty"` // 请求ID
        Path      string         `json:"path,omitempty"`       // 请求路径
}

// 业务状态码常量
const (
        // 成功状态码
        StatusSuccess = 0

        // 客户端错误码 1000-1999
        StatusBadRequest       = 1000 // 请求参数错误
        StatusValidationFailed = 1001 // 数据验证失败
        StatusNotFound         = 1002 // 资源不存在
        StatusConflict         = 1003 // 资源冲突
        StatusTooManyRequests  = 1004 // 请求过于频繁
        StatusMethodNotAllowed = 1005 // 请求方法不被允许

        // 服务器错误码 2000-2999
        StatusInternalServerError = 2000 // 内部服务器错误
        StatusNotImplemented      = 2001 // 功能未实现
        StatusServiceUnavailable  = 2002 // 服务不可用
        StatusGatewayTimeout      = 2003 // 网关超时
        StatusBadGateway          = 2004 // 网关错误

        // 业务错误码 3000-3999
        StatusDAGNotFound          = 3000 // DAG不存在
        StatusDAGInvalidState      = 3001 // DAG状态无效
        StatusInstanceNotFound     = 3002 // 实例不存在
        StatusInstanceInvalidState = 3003 // 实例状态无效
        StatusTaskNotFound         = 3004 // 任务不存在
        StatusTaskInvalidState     = 3005 // 任务状态无效
        StatusNodeNotFound         = 3006 // 节点不存在
        StatusPluginNotFound       = 3007 // 插件不存在
        StatusConfigInvalid        = 3008 // 配置无效
)

// 响应消息常量
const (
        MessageSuccess             = "操作成功"
        MessageBadRequest          = "请求参数错误"
        MessageNotFound            = "资源不存在"
        MessageMethodNotAllowed    = "请求方法不被允许"
        MessageConflict            = "资源冲突"
        MessageValidationFailed    = "数据验证失败"
        MessageTooManyRequests     = "请求过于频繁"
        MessageInternalServerError = "内部服务器错误"
        MessageNotImplemented      = "功能未实现"
        MessageBadGateway          = "网关错误"
        MessageServiceUnavailable  = "服务不可用"
        MessageGatewayTimeout      = "网关超时"
)

// ResponseWriter 响应写入器接口
type ResponseWriter interface {
        WriteJSON(w http.ResponseWriter, httpStatus int, data interface{})
        WriteError(w http.ResponseWriter, httpStatus int, businessStatus int, message string, details ...*ErrorDetail)
        WriteSuccess(w http.ResponseWriter, data interface{})
        WriteBadRequest(w http.ResponseWriter, message string, details ...*ErrorDetail)
        WriteNotFound(w http.ResponseWriter, message string)
        WriteValidationFailed(w http.ResponseWriter, message string, details ...*ErrorDetail)
        WriteInternalError(w http.ResponseWriter, message string)
}

// JSONResponseWriter JSON响应写入器
type JSONResponseWriter struct {
        RequestIDFunc func(r *http.Request) string
}

// NewJSONResponseWriter 创建JSON响应写入器
func NewJSONResponseWriter() *JSONResponseWriter <span class="cov8" title="1">{
        return &amp;JSONResponseWriter{
                RequestIDFunc: func(r *http.Request) string </span><span class="cov0" title="0">{
                        if r != nil </span><span class="cov0" title="0">{
                                return r.Header.Get("X-Request-ID")
                        }</span>
                        <span class="cov0" title="0">return ""</span>
                },
        }
}

// WriteJSON 写入JSON响应
func (w *JSONResponseWriter) WriteJSON(httpWriter http.ResponseWriter, httpStatus int, data interface{}) <span class="cov8" title="1">{
        response := &amp;Response{
                Status:    StatusSuccess,
                Msg:       MessageSuccess,
                Data:      data,
                Timestamp: time.Now().Unix(),
        }

        w.writeResponse(httpWriter, httpStatus, response)
}</span>

// WriteError 写入错误响应
func (w *JSONResponseWriter) WriteError(httpWriter http.ResponseWriter, httpStatus int, businessStatus int, message string, details ...*ErrorDetail) <span class="cov8" title="1">{
        errorResponse := &amp;ErrorResponse{
                Status:    businessStatus,
                Msg:       message,
                Details:   details,
                Timestamp: time.Now().Unix(),
        }

        w.writeResponse(httpWriter, httpStatus, errorResponse)
}</span>

// WriteSuccess 写入成功响应
func (w *JSONResponseWriter) WriteSuccess(httpWriter http.ResponseWriter, data interface{}) <span class="cov8" title="1">{
        w.WriteJSON(httpWriter, http.StatusOK, data)
}</span>

// WriteBadRequest 写入请求参数错误响应
func (w *JSONResponseWriter) WriteBadRequest(httpWriter http.ResponseWriter, message string, details ...*ErrorDetail) <span class="cov0" title="0">{
        w.WriteError(httpWriter, http.StatusBadRequest, StatusBadRequest, message, details...)
}</span>

// WriteNotFound 写入资源不存在响应
func (w *JSONResponseWriter) WriteNotFound(httpWriter http.ResponseWriter, message string) <span class="cov8" title="1">{
        w.WriteError(httpWriter, http.StatusNotFound, StatusNotFound, message)
}</span>

// WriteValidationFailed 写入数据验证失败响应
func (w *JSONResponseWriter) WriteValidationFailed(httpWriter http.ResponseWriter, message string, details ...*ErrorDetail) <span class="cov8" title="1">{
        w.WriteError(httpWriter, http.StatusUnprocessableEntity, StatusValidationFailed, message, details...)
}</span>

// WriteInternalError 写入内部服务器错误响应
func (w *JSONResponseWriter) WriteInternalError(httpWriter http.ResponseWriter, message string) <span class="cov0" title="0">{
        w.WriteError(httpWriter, http.StatusInternalServerError, StatusInternalServerError, message)
}</span>

// writeResponse 写入响应到HTTP Writer
func (w *JSONResponseWriter) writeResponse(httpWriter http.ResponseWriter, statusCode int, data interface{}) <span class="cov8" title="1">{
        httpWriter.Header().Set("Content-Type", "application/json; charset=utf-8")
        httpWriter.WriteHeader(statusCode)

        if err := json.NewEncoder(httpWriter).Encode(data); err != nil </span><span class="cov0" title="0">{
                // 如果JSON编码失败，写入简单的错误响应
                httpWriter.WriteHeader(http.StatusInternalServerError)
                fmt.Fprintf(httpWriter, `{"status":%d,"msg":"响应编码失败","timestamp":%d}`, StatusInternalServerError, time.Now().Unix())
        }</span>
}

// Success 创建成功响应
func Success(data interface{}) *Response <span class="cov8" title="1">{
        return &amp;Response{
                Status:    StatusSuccess,
                Msg:       MessageSuccess,
                Data:      data,
                Timestamp: time.Now().Unix(),
        }
}</span>

// SuccessList 创建列表成功响应
func SuccessList(items interface{}, pagination *PaginationInfo) *Response <span class="cov8" title="1">{
        var count int
        // 使用反射安全地获取长度
        if items != nil </span><span class="cov8" title="1">{
                switch v := items.(type) </span>{
                case []interface{}:<span class="cov0" title="0">
                        count = len(v)</span>
                case []map[string]interface{}:<span class="cov8" title="1">
                        count = len(v)</span>
                default:<span class="cov0" title="0">
                        // 使用反射获取切片长度
                        rv := reflect.ValueOf(items)
                        if rv.Kind() == reflect.Slice </span><span class="cov0" title="0">{
                                count = rv.Len()
                        }</span>
                }
        }

        <span class="cov8" title="1">listData := &amp;ListResponse{
                Items:      items,
                Pagination: pagination,
                Total:      pagination.Total,
                Count:      count,
        }

        return Success(listData)</span>
}

// Error 创建错误响应
func Error(status int, message string, details ...*ErrorDetail) *ErrorResponse <span class="cov8" title="1">{
        return &amp;ErrorResponse{
                Status:    status,
                Msg:       message,
                Details:   details,
                Timestamp: time.Now().Unix(),
        }
}</span>

// BadRequest 创建请求参数错误响应
func BadRequest(message string, details ...*ErrorDetail) *ErrorResponse <span class="cov0" title="0">{
        return Error(StatusBadRequest, message, details...)
}</span>

// NotFound 创建资源不存在错误响应
func NotFound(message string) *ErrorResponse <span class="cov0" title="0">{
        return Error(StatusNotFound, message)
}</span>

// Conflict 创建资源冲突错误响应
func Conflict(message string) *ErrorResponse <span class="cov0" title="0">{
        return Error(StatusConflict, message)
}</span>

// ValidationFailed 创建数据验证失败错误响应
func ValidationFailed(message string, details ...*ErrorDetail) *ErrorResponse <span class="cov8" title="1">{
        return Error(StatusValidationFailed, message, details...)
}</span>

// InternalServerError 创建内部服务器错误响应
func InternalServerError(message string) *ErrorResponse <span class="cov0" title="0">{
        return Error(StatusInternalServerError, message)
}</span>

// NewPagination 创建分页信息
func NewPagination(page, pageSize int, total int64) *PaginationInfo <span class="cov8" title="1">{
        if page &lt;= 0 </span><span class="cov0" title="0">{
                page = 1
        }</span>
        <span class="cov8" title="1">if pageSize &lt;= 0 </span><span class="cov0" title="0">{
                pageSize = 20
        }</span>

        <span class="cov8" title="1">totalPages := int((total + int64(pageSize) - 1) / int64(pageSize))

        return &amp;PaginationInfo{
                Page:       page,
                PageSize:   pageSize,
                TotalPages: totalPages,
                Total:      total,
                HasNext:    page &lt; totalPages,
                HasPrev:    page &gt; 1,
        }</span>
}

// GetOffset 获取偏移量
func (p *PaginationInfo) GetOffset() int <span class="cov8" title="1">{
        return (p.Page - 1) * p.PageSize
}</span>

// GetLimit 获取限制数量
func (p *PaginationInfo) GetLimit() int <span class="cov8" title="1">{
        return p.PageSize
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
